name: iOS-ipa-build  # å·¥ä½œæµåç§°ï¼Œæ˜¾ç¤ºåœ¨ GitHub ä»“åº“çš„ Actions æ ‡ç­¾é¡µä¸­

on:
  workflow_dispatch:  # è§¦å‘æ¡ä»¶ï¼šæ‰‹åŠ¨æ‰§è¡Œï¼ˆéœ€åœ¨ GitHub ä»“åº“çš„ Actions ä¸­æ‰‹åŠ¨è¿è¡Œï¼‰

jobs:
  build-ios:  # ä»»åŠ¡åç§°
    name: ğŸ‰ iOS Build  # ä»»åŠ¡æ˜¾ç¤ºåç§°
    runs-on: macos-latest  # è¿è¡Œç¯å¢ƒï¼šæœ€æ–°ç‰ˆ macOSï¼ˆå¿…é¡»ï¼Œå› ä¸ºéœ€è¦ Xcode å·¥å…·é“¾æ„å»º iOS åº”ç”¨ï¼‰
    steps:
      - uses: actions/checkout@v3  # GitHub å®˜æ–¹åŠ¨ä½œï¼šå°†ä»“åº“ä»£ç æ£€å‡ºåˆ°è¿è¡Œç¯å¢ƒ

      - uses: subosito/flutter-action@v2  # ç¬¬ä¸‰æ–¹åŠ¨ä½œï¼šå¿«é€Ÿå®‰è£…æŒ‡å®šç‰ˆæœ¬çš„ Flutter SDK
        with:
          channel: 'stable'  # ä½¿ç”¨ Flutter ç¨³å®šç‰ˆï¼ˆå¯é€‰ï¼šstable/beta/devï¼‰
          architecture: x64  # æŒ‡å®š Flutter SDK çš„æ¶æ„ä¸º x64ï¼ˆé€‚é… macOS ç¯å¢ƒï¼‰
      
      - run: flutter pub get  # è¿è¡Œ Flutter å‘½ä»¤ï¼šè·å–é¡¹ç›®ä¾èµ–çš„ pub åŒ…

      - name: Generate app icons  # è‡ªåŠ¨ç”Ÿæˆåº”ç”¨å›¾æ ‡ï¼ˆç¡®ä¿ CI ç¯å¢ƒæœ‰æ­£ç¡®çš„å›¾æ ‡æ–‡ä»¶ï¼‰
        run: flutter pub run flutter_launcher_icons

      - run: pod repo update  # è¿è¡Œ CocoaPods å‘½ä»¤ï¼šæ›´æ–°æœ¬åœ° Pod ä»“åº“
        working-directory: ios  # æŒ‡å®šå·¥ä½œç›®å½•ä¸ºé¡¹ç›®çš„ ios å­ç›®å½•ï¼ˆiOS åŸç”Ÿå·¥ç¨‹æ‰€åœ¨ä½ç½®ï¼‰

      - run: flutter build ios --release --no-codesign  # æ„å»º iOS å‘å¸ƒç‰ˆï¼Œè·³è¿‡ä»£ç ç­¾å

      - run: mkdir Payload  # åˆ›å»º Payload ç›®å½•ï¼Œç”¨äºå­˜æ”¾ IPA æ–‡ä»¶
        working-directory: build/ios/iphoneos  # å·¥ä½œç›®å½•ï¼šiOS æ„å»ºè¾“å‡ºè·¯å¾„

      - run: mv Runner.app/ Payload  # å°† Runner.app ç§»åŠ¨åˆ° Payload æ–‡ä»¶å¤¹
        working-directory: build/ios/iphoneos  # å·¥ä½œç›®å½•ï¼šiOS æ„å»ºè¾“å‡ºè·¯å¾„

      - name: Zip output  # æ­¥éª¤æ˜¾ç¤ºåç§°ï¼ˆå¯é€‰ï¼‰
        run: zip -qq -r -9 FlutterIpaExport.ipa Payload  # å‹ç¼© Payload æ–‡ä»¶å¤¹ä¸º IPA
        working-directory: build/ios/iphoneos  # å·¥ä½œç›®å½•ï¼šiOS æ„å»ºè¾“å‡ºè·¯å¾„

      - name: Upload binaries to release  # æ­¥éª¤æ˜¾ç¤ºåç§°ï¼ˆå¯é€‰ï¼‰
        uses: svenstaro/upload-release-action@v2  # ç¬¬ä¸‰æ–¹åŠ¨ä½œï¼šä¸Šä¼ æ–‡ä»¶åˆ° GitHub Release
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}  # GitHub è®¤è¯ä»¤ç‰Œï¼ˆè‡ªåŠ¨è·å–ï¼Œæ— éœ€æ‰‹åŠ¨é…ç½®ï¼‰
          file: build/ios/iphoneos/FlutterIpaExport.ipa  # å¾…ä¸Šä¼ çš„ IPA æ–‡ä»¶è·¯å¾„
          tag: v1.0  # å…³è”çš„ GitHub Release æ ‡ç­¾ï¼ˆè‹¥ä¸å­˜åœ¨ä¼šè‡ªåŠ¨åˆ›å»ºï¼‰
          overwrite: true  # è¦†ç›–åŒæ ‡ç­¾ä¸‹çš„åŒåæ–‡ä»¶ï¼ˆå…è®¸é‡å¤æ‰§è¡Œæ—¶æ›´æ–°ï¼‰
          body: "This is first release"  # Release çš„æè¿°ä¿¡æ¯
